<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 97</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:15px;font-family:DejaVuSerif;color:#000000;}
	.ft01{font-size:20px;font-family:DejaVuSerif;color:#000000;}
	.ft02{font-size:10px;font-family:DejaVuSerif;color:#000000;}
	.ft03{font-size:10px;font-family:DejaVuSerif;color:#0000ee;}
	.ft04{font-size:10px;font-family:DejaVuSerif;color:#000000;}
	.ft05{font-size:10px;font-family:DejaVuSansMono;color:#000000;}
	.ft06{font-size:10px;line-height:11px;font-family:DejaVuSerif;color:#000000;}
	.ft07{font-size:10px;line-height:12px;font-family:DejaVuSerif;color:#000000;}
	.ft08{font-size:10px;line-height:11px;font-family:DejaVuSansMono;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page97-div" style="position:relative;width:892px;height:1263px;">
<img width="892" height="1263" src="ALL-07052021097.png" alt="background image"/>
<p style="position:absolute;top:67px;left:59px;white-space:nowrap" class="ft00"><b>chroot&#160;as&#160;an&#160;alternative&#160;to&#160;full&#160;virtualization</b></p>
<p style="position:absolute;top:123px;left:59px;white-space:nowrap" class="ft01"><b>chroot&#160;as&#160;an&#160;alternative&#160;to&#160;full&#160;virtualization</b></p>
<p style="position:absolute;top:161px;left:59px;white-space:nowrap" class="ft02">Author:&#160;L.S.Lowe.&#160;File:&#160;syschroot.&#160;This&#160;update:&#160;20120602.&#160;Part&#160;of&#160;</p>
<p style="position:absolute;top:161px;left:398px;white-space:nowrap" class="ft03">Guide&#160;to&#160;the&#160;Local&#160;System</p>
<p style="position:absolute;top:161px;left:532px;white-space:nowrap" class="ft02">.</p>
<p style="position:absolute;top:183px;left:59px;white-space:nowrap" class="ft06">We&#160;have&#160;a&#160;cluster&#160;and&#160;a&#160;set&#160;of&#160;desktop&#160;PCs&#160;where&#160;the&#160;base&#160;system&#160;is&#160;Fedora&#160;12&#160;or&#160;Fedora&#160;15,&#160;but&#160;where&#160;there&#160;are&#160;also&#160;available&#160;complete&#160;SL4.8&#160;and&#160;SL5.4<br/>sub-systems,&#160;where&#160;SL&#160;is&#160;Scientific&#160;Linux,&#160;similar&#160;to&#160;CentOS&#160;and&#160;based&#160;on&#160;Red&#160;Hat&#160;Enterprise&#160;Linux.&#160;There's&#160;the&#160;opportunity&#160;to&#160;extend&#160;that&#160;to&#160;have&#160;a<br/>bigger&#160;set&#160;of&#160;different&#160;sub-systems,&#160;including&#160;32-bit&#160;and&#160;64-bit&#160;versions&#160;of&#160;the&#160;same&#160;system,&#160;if&#160;we&#160;wanted&#160;them.</p>
<p style="position:absolute;top:229px;left:59px;white-space:nowrap" class="ft06">Additional&#160;filesystems&#160;which&#160;you&#160;would&#160;normally&#160;expect&#160;to&#160;see&#160;in&#160;a&#160;native&#160;system&#160;(like&#160;the&#160;filesystem&#160;that&#160;contains&#160;your&#160;$HOME&#160;directory,&#160;and&#160;optionally<br/>the&#160;/tmp&#160;filesystem)&#160;are&#160;specially&#160;mounted&#160;inside&#160;the&#160;alternative&#160;images&#160;too.</p>
<p style="position:absolute;top:264px;left:59px;white-space:nowrap" class="ft07">Users&#160;switch&#160;to&#160;one&#160;of&#160;the&#160;alternative&#160;sub-systems&#160;using&#160;a&#160;specially&#160;written&#160;binary&#160;like&#160;my&#160;imageswitch&#160;command&#160;invoked&#160;as&#160;<b>sl4</b>&#160;or&#160;<b>sl5</b>&#160;or&#160;(earlier)<br/><b>/bin4/bash</b>&#160;which&#160;provides&#160;the&#160;required&#160;</p>
<p style="position:absolute;top:276px;left:269px;white-space:nowrap" class="ft02">chroot&#160;to&#160;the&#160;alternative&#160;system.&#160;For&#160;our&#160;desktop&#160;systems,&#160;users&#160;get&#160;a&#160;SL4&#160;and&#160;SL5&#160;icon&#160;which&#160;opens&#160;a&#160;window&#160;in</p>
<p style="position:absolute;top:289px;left:59px;white-space:nowrap" class="ft06">the&#160;corresponding&#160;environment.&#160;For&#160;jobs,&#160;users&#160;use&#160;the&#160;<b>qsub4</b>&#160;or&#160;<b>qsub5</b>&#160;commands,&#160;which&#160;make&#160;use&#160;of&#160;the&#160;<b>-D</b>&#160;option&#160;of&#160;the&#160;qsub&#160;command&#160;in&#160;Torque,&#160;as<br/>Torque&#160;provides&#160;its&#160;own&#160;perfectly&#160;useable&#160;internal&#160;chroot&#160;facility&#160;(since&#160;version&#160;1.1.0p3).</p>
<p style="position:absolute;top:323px;left:59px;white-space:nowrap" class="ft02">This&#160;is&#160;a&#160;bit&#160;different&#160;to&#160;the&#160;normal&#160;use&#160;of&#160;the&#160;chroot&#160;system&#160;call,&#160;which&#160;normally&#160;is&#160;used&#160;in&#160;order&#160;to&#160;give&#160;</p>
<p style="position:absolute;top:322px;left:596px;white-space:nowrap" class="ft02">less&#160;access&#160;to&#160;system&#160;facilities,&#160;rather&#160;than&#160;similar</p>
<p style="position:absolute;top:335px;left:59px;white-space:nowrap" class="ft06">access&#160;to&#160;a&#160;different&#160;system:&#160;for&#160;example&#160;a&#160;chrooted&#160;environment&#160;used&#160;in&#160;a&#160;web&#160;server&#160;for&#160;security&#160;purposes.&#160;See&#160;reference&#160;links&#160;at&#160;the&#160;bottom&#160;of&#160;the&#160;page<br/>for&#160;more&#160;examples&#160;of&#160;Container&#160;virtualization.</p>
<p style="position:absolute;top:371px;left:59px;white-space:nowrap" class="ft00"><b>Why&#160;does&#160;it&#160;work?</b></p>
<p style="position:absolute;top:402px;left:59px;white-space:nowrap" class="ft07">When&#160;you&#160;enter&#160;one&#160;of&#160;the&#160;special&#160;commands&#160;like&#160;<b>/bin4/sh</b>,&#160;then&#160;the&#160;command&#160;changes&#160;the&#160;filesystem&#160;root&#160;to&#160;the&#160;root&#160;of&#160;the&#160;alternative&#160;installation,&#160;eg<br/>SL4,&#160;&#160;changes&#160;the&#160;current&#160;directory&#160;to&#160;the&#160;same&#160;directory&#160;but&#160;in&#160;the&#160;SL4&#160;image,&#160;and&#160;then&#160;invokes&#160;the&#160;command&#160;of&#160;the&#160;same&#160;name&#160;in&#160;the&#160;SL4&#160;image.&#160;So<br/><b>/bin4/bash</b>&#160;invokes&#160;bash&#160;in&#160;the&#160;changed-root&#160;system.&#160;Because&#160;your&#160;$HOME&#160;and&#160;other&#160;files&#160;are&#160;mounted&#160;in&#160;the&#160;SL4&#160;image&#160;also,&#160;you&#160;can&#160;continue&#160;to&#160;see<br/>them.</p>
<p style="position:absolute;top:461px;left:59px;white-space:nowrap" class="ft06">Your&#160;programs&#160;will&#160;therefore&#160;use&#160;the&#160;scripts&#160;and&#160;run-time&#160;libraries&#160;and&#160;other&#160;system&#160;files&#160;of&#160;the&#160;SL4&#160;or&#160;SL5&#160;installation,&#160;rather&#160;than&#160;the&#160;native&#160;installation.<br/>So&#160;they&#160;are&#160;operating&#160;in&#160;a&#160;virtual&#160;application&#160;environment.&#160;Those&#160;libraries&#160;may&#160;call&#160;a&#160;system&#160;kernel&#160;interface&#160;to&#160;provide&#160;certain&#160;facilities,&#160;and&#160;in&#160;this&#160;case<br/>that&#160;kernel&#160;is&#160;the&#160;native&#160;Fedora&#160;12&#160;kernel,&#160;not&#160;a&#160;SL4&#160;or&#160;SL5&#160;kernel.&#160;However,&#160;the&#160;assumption&#160;is&#160;that&#160;the&#160;kernel&#160;facilities&#160;are&#160;backward-compatible&#160;between<br/>Fedora&#160;12,&#160;SL5&#160;and&#160;SL4.</p>
<p style="position:absolute;top:519px;left:59px;white-space:nowrap" class="ft06">As&#160;an&#160;analogy,&#160;consider&#160;a&#160;fully-resolved&#160;(static)&#160;program.&#160;If&#160;and&#160;when&#160;a&#160;program&#160;is&#160;compiled&#160;on&#160;one&#160;system&#160;with&#160;all&#160;library&#160;references&#160;resolved,&#160;and&#160;so&#160;with<br/>no&#160;run-time&#160;libraries,&#160;and&#160;you&#160;copy&#160;it&#160;to&#160;a&#160;second&#160;different&#160;system,&#160;you&#160;would&#160;expect&#160;it&#160;to&#160;work&#160;flawlessly,&#160;if&#160;the&#160;second&#160;system&#160;was&#160;later&#160;but&#160;backwards-<br/>compatible&#160;with&#160;the&#160;first&#160;system.&#160;It&#160;would&#160;be&#160;a&#160;very&#160;brave&#160;or&#160;foolhardy&#160;vendor&#160;or&#160;kernel&#160;developer&#160;who&#160;altered&#160;the&#160;kernel&#160;interfaces&#160;to&#160;cause&#160;such&#160;a&#160;static<br/>program&#160;to&#160;fail.&#160;In&#160;our&#160;case,&#160;we&#160;are&#160;not&#160;fully-resolving&#160;the&#160;library&#160;references&#160;but&#160;instead&#160;we&#160;are&#160;providing&#160;all&#160;the&#160;run-time&#160;libraries&#160;of&#160;the&#160;first&#160;system&#160;too;<br/>we&#160;rely&#160;equally&#160;on&#160;the&#160;backward-compatibility&#160;of&#160;the&#160;kernel&#160;interfaces,&#160;and&#160;so&#160;for&#160;the&#160;same&#160;reason&#160;we&#160;expect&#160;that&#160;method&#160;to&#160;work&#160;flawlessly&#160;too.</p>
<p style="position:absolute;top:591px;left:59px;white-space:nowrap" class="ft00"><b>What&#160;the&#160;syschroot&#160;method&#160;preserves</b></p>
<p style="position:absolute;top:621px;left:84px;white-space:nowrap" class="ft06">it&#160;preserves&#160;all&#160;environment&#160;variables,&#160;including&#160;Torque&#160;ones&#160;like&#160;PBS_JOBID&#160;and&#160;PBS_O_WORKDIR,<br/>&#160;it&#160;accepts&#160;and&#160;passes&#160;on&#160;the&#160;supplied&#160;arguments,<br/>it&#160;can&#160;be&#160;used&#160;in&#160;a&#160;script&#160;#!interpreter&#160;line,<br/>it&#160;preserves&#160;the&#160;current&#160;directory,<br/>it&#160;preserves&#160;the&#160;current&#160;umask</p>
<p style="position:absolute;top:694px;left:59px;white-space:nowrap" class="ft00"><b>The&#160;extra&#160;mounts&#160;required</b></p>
<p style="position:absolute;top:724px;left:59px;white-space:nowrap" class="ft06">The&#160;alternative&#160;system(s)&#160;need&#160;to&#160;have&#160;additional&#160;mounts&#160;in&#160;place&#160;in&#160;order&#160;for&#160;things&#160;to&#160;work&#160;as&#160;expected.&#160;For&#160;example,&#160;the&#160;users'&#160;files&#160;will&#160;almost&#160;certainly<br/>need&#160;to&#160;be&#160;available&#160;within&#160;the&#160;chrooted&#160;system,&#160;and&#160;so&#160;will&#160;need&#160;to&#160;be&#160;mounted&#160;there.&#160;This&#160;mounting&#160;can&#160;be&#160;done&#160;at&#160;native-system&#160;boot&#160;time:&#160;there&#160;is&#160;no<br/>need&#160;to&#160;do&#160;it&#160;later&#160;at&#160;the&#160;time&#160;the&#160;user(s)&#160;actually&#160;switch&#160;to&#160;the&#160;alternative&#160;system.</p>
<p style="position:absolute;top:771px;left:59px;white-space:nowrap" class="ft06">The&#160;<b>--bind</b>&#160;option&#160;of&#160;mount&#160;is&#160;invaluable&#160;here&#160;(similar&#160;to&#160;-o&#160;bind).&#160;Without&#160;bind,&#160;you&#160;might&#160;have&#160;to&#160;mount&#160;mount&#160;your&#160;NFS&#160;file-systems&#160;at&#160;several&#160;different<br/>places,&#160;which&#160;for&#160;me&#160;(from&#160;monitoring&#160;packets&#160;for&#160;a&#160;mount&#160;with&#160;a&#160;2.6.38&#160;kernel)&#160;is&#160;different&#160;from&#160;and&#160;less&#160;efficient&#160;than&#160;bind&#160;mounting,&#160;and,&#160;without&#160;bind,<br/>it's&#160;possible&#160;that&#160;some&#160;file-systems&#160;like&#160;GPFS&#160;would&#160;not&#160;be&#160;able&#160;to&#160;be&#160;replicated&#160;within&#160;the&#160;chrooted&#160;system.</p>
<p style="position:absolute;top:818px;left:59px;white-space:nowrap" class="ft02">So&#160;the&#160;following&#160;might&#160;be&#160;added&#160;in&#160;the&#160;<b>/etc/rc.d/rc.local</b>&#160;file&#160;of&#160;the&#160;native&#160;system:</p>
<p style="position:absolute;top:840px;left:59px;white-space:nowrap" class="ft08">ch=/sysroot/SL48<br/>nfsmounts=...&#160;customise&#160;...<br/>for&#160;f&#160;in&#160;/dev&#160;/dev/pts&#160;/dev/shm&#160;/proc&#160;/sys&#160;/tmp&#160;/selinux;&#160;do<br/>&#160;&#160;mount&#160;--bind&#160;$f&#160;$ch/$f<br/>done</p>
<p style="position:absolute;top:909px;left:59px;white-space:nowrap" class="ft08">for&#160;f&#160;in&#160;$nfsmounts;&#160;do<br/>&#160;&#160;mkdir&#160;-p&#160;$ch/$f<br/>&#160;&#160;mount&#160;--bind&#160;$f&#160;$ch/$f<br/>done</p>
<p style="position:absolute;top:979px;left:59px;white-space:nowrap" class="ft02">This&#160;needs&#160;customising&#160;for&#160;a&#160;particular&#160;scenario:</p>
<p style="position:absolute;top:1001px;left:84px;white-space:nowrap" class="ft06">Mounting&#160;all&#160;of&#160;/dev&#160;gives&#160;us&#160;easy&#160;access&#160;to&#160;the&#160;/dev/null,&#160;/dev/zero&#160;and&#160;/dev/random&#160;special&#160;files,&#160;if&#160;these&#160;are&#160;not&#160;already&#160;populated&#160;in&#160;the&#160;alternative<br/>image,&#160;and&#160;to&#160;the&#160;/dev/log&#160;socket&#160;(see&#160;syslogd&#160;section&#160;below).&#160;Some&#160;may&#160;prefer&#160;to&#160;populate&#160;the&#160;/dev&#160;directory&#160;with&#160;a&#160;particular&#160;small&#160;set&#160;of&#160;device-<br/>files.&#160;If&#160;you&#160;choose&#160;the&#160;latter,&#160;then&#160;note&#160;that:</p>
<p style="position:absolute;top:1048px;left:109px;white-space:nowrap" class="ft02">Mounting&#160;/dev/pts,&#160;/dev/shm,&#160;/proc&#160;and&#160;/sys&#160;can&#160;be&#160;done&#160;without&#160;using&#160;bind:&#160;eg&#160;for&#160;/proc:&#160;<b>mount&#160;-t&#160;proc&#160;myproc&#160;$ch/proc</b></p>
<p style="position:absolute;top:1070px;left:109px;white-space:nowrap" class="ft06">/dev/ptmx&#160;and&#160;directory&#160;/dev/pts&#160;gives&#160;access&#160;to&#160;pseudo-terminals,&#160;without&#160;which&#160;commands&#160;like&#160;<b>xterm</b>&#160;cannot&#160;be&#160;executed&#160;in&#160;the&#160;chrooted<br/>environment</p>
<p style="position:absolute;top:1104px;left:109px;white-space:nowrap" class="ft02">/dev/tty&#160;is&#160;required&#160;for&#160;certain&#160;commands&#160;to&#160;work&#160;(eg&#160;klog)</p>
<p style="position:absolute;top:1126px;left:109px;white-space:nowrap" class="ft02">/dev/fuse&#160;is&#160;required&#160;for&#160;fusermount&#160;to&#160;work</p>
<p style="position:absolute;top:1148px;left:84px;white-space:nowrap" class="ft02">/proc&#160;is&#160;required&#160;for&#160;certain&#160;commands&#160;to&#160;work&#160;(...).</p>
<p style="position:absolute;top:1170px;left:84px;white-space:nowrap" class="ft02">/tmp&#160;might&#160;be&#160;included&#160;if&#160;this&#160;is&#160;a&#160;separate&#160;large&#160;file-space,&#160;so&#160;that&#160;a&#160;similarly&#160;large&#160;space&#160;will&#160;be&#160;available&#160;in&#160;the&#160;chrooted&#160;environment.</p>
</div>
</body>
</html>
